language: ruby
rvm: 2.7.1
before_install:
- gem install bundler
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
cache: bundler
jobs:
  include:
  - stage: test
    script: bundle exec rspec -fd
  - stage: deploy qa
    if: type IN (push) and branch = qa
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_QA
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_QA
    script:
    - terraform -chdir=provisioning/qa init -input=false
    - echo "Deploying to qa"
    - terraform -chdir=provisioning/qa apply -auto-approve -input=false
  - stage: deploy production
    if: type IN (push) and branch = main
    env:
    - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_PRODUCTION
    - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_PRODUCTION
    script:
    - terraform -chdir=provisioning/production init -input=false
    - echo "Deploying to production"
    - terraform -chdir=provisioning/production apply -auto-approve -input=false
notifications:
  email:
    on_failure: always
env:
  global:
  - TF_VERSION=1.0.11
  - secure: xqc7vhlVO8YfQPQIvqZEf1cojPngGlvce0ErKcY8ThBe0yeKjyk6tHzpuBPAhJxMk70Cq5p0lJe6lzzSs/BZ64ScJhSjGQOYcLrmyeecbAk0AofCir+CFbQ92sTZH23c/Gh6q06canBvm8qxh8xevIjGvn9NuYu/15oKrX7Y5gr2jiJfLnwdnMECifZuY8nc7UAzMFmKT9Rgqw4AL2r3Hj2xiXfLbTidGSxFuNSbf7Pr4mv76EJJJsZnj8FnpLbGbUW4UbumQnEOUcTN1lm/NTnxVgkHkNydtxm7u0ZgKckRwElaFn2kv/2FBtPx7ZrndcOi54JJV2Ek6GCeHevXubC+/f8eTndXF6KvcPIyjAZaM5/bQvZoT00XZaJej8Yy9h9WwtsVuYH1WZ80Ng4ZiPzsazRY1Rgli91HTQVfkijgt3W6JK/kt84YIQgl6+a47G075XMjRIcSJgrwZ+bg0ebap+ZPip+Pr7rnHmEDm9HS/azmBLXAAd+X2XIqgrx5tId0QQ5FNBsONTfZLMcVriipExFdoDSy0rM7TkNgvWM0amIzxbyQjRoZ9dA7X7jo3EXUmOx8hIXB5cj8y4jIDOivY0ajePiG7kg4aDBi/qsXiftkrDrOIosqL4yB/hC/rWTetxWOBkYDA03DGXrMKVPl8rZ3XusxEH8OHbMERvE=
